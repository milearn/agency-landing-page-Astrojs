---
export interface Props {
  id: string;
}

import Info from "../cards/Info.astro";
import Button from "./Button.astro";
import Paragraph from "./Paragraph.astro";
const { id } = Astro.props;
---

<div class="flex sm:flex-row flex-col gap-5 w-full justify-center relative">
  <form
    id={id}
    action="#"
    class="get_started_form py-1 pl-6 w-full pr-1 flex gap-3 items-center text-heading-3 shadow-lg shadow-box-shadow
                border border-box-border bg-box-bg rounded-full ease-linear focus-within:bg-body focus-within:border-primary"
  >
    <span class="min-w-max pr-2 border-r border-box-border">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        stroke="currentColor"
        width="24"
        height="24"
        viewBox="0 0 256 256"
        fill="none"
        stroke-width="5px"
        stroke-miterlimit="10"
        ><g
          ><path
            d="M235.345 182.713h-24.24a2.807 2.807 0 0 1-2.81-2.81 2.807 2.807 0 0 1 2.81-2.81h24.24c7.356 0 13.339-5.982 13.339-13.339V55.227c0-7.357-5.983-13.34-13.34-13.34H73.838a2.811 2.811 0 0 1 0-5.62h161.508c10.456 0 18.962 8.506 18.962 18.962v108.525c0 10.454-8.506 18.96-18.962 18.96z"
          ></path><path
            d="m178.9 109.49 48.74-44.715a2.809 2.809 0 1 0-3.796-4.142l-69.253 63.528L93.08 67.734a2.809 2.809 0 0 0-3.97.171 2.809 2.809 0 0 0 .17 3.97l41.002 37.615-23.242 21.32a2.811 2.811 0 0 0 3.8 4.142l23.595-21.651 18.254 16.745a2.809 2.809 0 0 0 3.799 0L174.74 113.3l49.1 45.044c.536.495 1.22.74 1.9.74a2.809 2.809 0 0 0 1.897-4.881l-48.738-44.714z"
          ></path><path
            d="M145.023 219.446c-27.912 0-64.369-23.458-92.264-51.353C15.614 130.95-13.66 78.623 9.837 51.515c1.124-1.296 2.588-2.305 4.355-2.999 3.125-1.225 8.942-3.68 16.826-7.1 3.578-1.552 7.003-3.052 9.633-4.21 4.14-1.818 8.995-.25 11.302 3.639L74.2 78.336a9.004 9.004 0 0 1 .188 8.815l-13.794 25.697a3.323 3.323 0 0 0 .581 3.946l42.884 42.883a3.324 3.324 0 0 0 3.945.582l25.697-13.792a9.013 9.013 0 0 1 8.813.186l37.496 22.25a8.966 8.966 0 0 1 3.636 11.301c-1.157 2.63-2.655 6.056-4.206 9.63v.003c-3.487 8.042-5.879 13.701-7.104 16.826-.686 1.76-1.694 3.226-2.993 4.353-6.746 5.85-15.064 8.43-24.32 8.43zM33.036 46.664c-7.941 3.446-13.59 5.828-16.79 7.084-.91.357-1.638.843-2.16 1.448-21.143 24.39 7.286 73.56 42.65 108.924 35.363 35.363 84.536 63.79 108.926 42.65.604-.526 1.09-1.248 1.445-2.158.382-.973.874-2.184 1.47-3.622l-.178.177 5.915-13.626a2062.15 2062.15 0 0 1 4.196-9.599 3.336 3.336 0 0 0-1.36-4.204l-37.5-22.25a3.351 3.351 0 0 0-3.288-.07l-25.694 13.792c-3.515 1.883-7.767 1.259-10.583-1.56l-42.883-42.88a8.913 8.913 0 0 1-1.56-10.583L69.437 84.49a3.366 3.366 0 0 0-.07-3.288L47.12 43.712c-.86-1.45-2.67-2.04-4.207-1.36-2.692 1.182-6.21 2.725-9.877 4.312zm143.639 141.88-1.804-1.804 1.804 1.804z"
          ></path></g
        ></svg
      >
    </span>
    <input
      name=""
      autocomplete="email mobile"
      placeholder="Enter your email or phone"
      class="w-full py-3 outline-none bg-transparent contact_details"
    />

    <input type="submit" hidden />
    <Button
      id="get_started_button"
      variant={"primary"}
      className={"min-w-max text-white "}
    >
      <span class="hidden sm:flex relative z-[5]"> Get Started</span>
      <span class="flex sm:hidden relative z-[5]">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
          ></path>
        </svg>
      </span>
    </Button>
    <span
      class="hidden input_error text-xs md:text-sm font-thin text-[#ff6969] absolute -bottom-6 md:-bottom-7 animate-fade-in"
    >
      Something went wrong. Please try Again.
    </span>
  </form>
  <div
    id="dialog"
    class="fixed left-0 top-0 bg-black/[.8] hidden w-screen h-screen transition-opacity duration-500 z-10"
  >
    <div
      class="bg-white relative rounded shadow-md p-8 mx-auto my-20 w-full lg:w-1/2"
    >
      <iframe
        class="survey-form"
        src="https://app.youform.com/forms/tq5uavv2"
        loading="lazy"
        width="100%"
        height="500"
        frameborder="0"
        marginheight="0"
        marginwidth="0"></iframe>
      <div
        class="close-btn absolute top-[12px] right-[12px] text-black text-sm hidden cursor-pointer"
      >
        X
      </div>
    </div>
  </div>

  <Paragraph
    className="hidden thanks_reponse text-center animate-fade-in	px-7 py-4 bg-slate-300/10 drop-shadow-2xl rounded-2xl	"
  >
    <span class="text-lg md:text-xl font-semibold text-heading-2">
      Thanks for your response !
    </span><br />
    Our team will get back to you shortly..
  </Paragraph>
</div>

<script define:vars={{ id }} is:inline>
  // const addEntry = (detail) =>
  // fetch(
  //   "https://script.google.com/macros/s/AKfycbxO_w5TQqow3TzF5y7TK0yGarRkP43412LeZyywYP7GCssD3M6De8o0CRpzF5U_6NXb/exec",
  //   {
  //     redirect: "follow",
  //     method: "POST",
  //     body: `Contact=${detail}&Time=${new Date().toString()}`,
  //     headers: {
  //       "Content-Type": "text/plain;charset=utf-8",
  //     },
  //   }
  // );
  // For testing
  const addEntry = (detail) => Promise.resolve(detail);
  const regex = new RegExp(
    `(^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$)|(^[0-9]{10}$)`
  );

  const form = document.getElementById(id);
  const inputElm = form.querySelector(".contact_details");
  const btnElm = form.querySelector("#get_started_button");
  const errorTextElm = form.querySelector(".input_error");
  const closeBtn = document.getElementsByClassName("close-btn")[0];

  form?.addEventListener("keydown", (event) => {
    errorTextElm.classList.add("hidden");
    errorTextElm.innerHTML = "";
  });
  function showDialog() {
    const dialog = document.getElementById("dialog");
    dialog.classList.remove("hidden");
    document
      .getElementsByTagName("body")[0]
      .classList.remove("overflow-y-auto");
    setTimeout(() => {
      dialog.classList.remove("opacity-0");
    }, 20);
    setTimeout(() => {
      document
        .getElementsByClassName("close-btn")[0]
        .classList.remove("hidden");
    }, 30 * 1000);
  }
  function hideDialog() {
    let dialog = document.getElementById("dialog");
    dialog.classList.add("opacity-0");
    document.getElementsByTagName("body")[0].classList.add("overflow-y-auto");

    setTimeout(() => {
      dialog.classList.add("hidden");
    }, 500);
  }

  closeBtn.addEventListener("click", hideDialog);

  form?.addEventListener("submit", (event) => {
    event.preventDefault();

    const contactValue = inputElm.value;

    if (!regex.test(inputElm.value)) {
      errorTextElm.classList.remove("hidden");
      errorTextElm.innerHTML =
        "Please enter valid email or 10 digit mobile number.";
      return;
    }

    inputElm.setAttribute("disabled", "true");
    btnElm.setAttribute("disabled", "true");

    document.querySelectorAll(".get_started_form").forEach((elm) => {
      elm.classList.add("motion-safe:animate-pulse", "cursor-not-allowed");
    });
    showDialog();
    addEntry(contactValue)
      .then(() => {
        errorTextElm.classList.add("hidden");
        document.querySelectorAll(".get_started_form").forEach((elm) => {
          elm.classList.add("hidden");
        });
        document.querySelectorAll(".thanks_reponse").forEach((elm) => {
          elm.classList.remove("hidden");
        });
      })
      .catch(() => {
        errorTextElm.classList.remove("hidden");
        errorTextElm.innerHTML = "Something went wrong. Please try Again.";
      })
      .finally(() => {
        inputElm.setAttribute("disabled", "false");
        btnElm.setAttribute("disabled", "false");

        document.querySelectorAll(".get_started_form").forEach((elm) => {
          elm.classList.remove(
            "motion-safe:animate-pulse",
            "cursor-not-allowed"
          );
        });
      });
  });
</script>
